# This pipeline is triggered by pushes to the 'main' branch
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - 'app/*' # Only run if the 'app' folder changes

# Use a standard Ubuntu agent from Microsoft's pool
pool:
  vmImage: 'ubuntu-latest'

# --- COMBINED VARIABLES ---
variables:
- group: gcp-secrets # Link to the secure variable group
- name: GCP_PROJECT_ID
  value: 'tranquil-leaf-472813-v8'
- name: GCP_REGION
  value: 'us-central1'
- name: GCP_SERVICE_NAME
  value: 'shop-app'
- name: DOCKER_REGISTRY_PATH
  value: 'us-central1-docker.pkg.dev/tranquil-leaf-472813-v8/shop-app-repo'
- name: IMAGE_NAME
  value: 'shop-app'
- name: IMAGE_TAG
  value: '$(Build.BuildId)'
- name: APP_FOLDER
  value: 'app' 

# --- PIPELINE STAGES ---
stages:
- stage: Build_and_Deploy
  displayName: Build and Deploy to Cloud Run
  jobs:
  - job: Deploy
    displayName: Build, Push, and Deploy
    steps:
    
    # 1. Write the raw SA Key to a temporary file
    # NOTE: This is the temporary solution for corrupted JSON key data
    - script: |
        echo '$(GCP_SA_KEY)' > $(Agent.TempDirectory)/gcp-key.json
      displayName: '1. Write SA Key (Raw JSON)'

    # 2. Activate the Service Account (Auth)
    - script: |
        # Authenticate using the key file
        gcloud auth activate-service-account --key-file=$(Agent.TempDirectory)/gcp-key.json --project=$(GCP_PROJECT_ID)
      displayName: '2. Activate Service Account (Auth)'
      
    # 3. Configure Docker for Google Artifact Registry
    - script: gcloud auth configure-docker $(GCP_REGION)-docker.pkg.dev --quiet
      displayName: '3. Configure Docker for Artifact Registry'
      
    # 4. Build the Docker Image (FIXED PATHS)
    - task: Docker@2
      displayName: '4. Build Docker Image'
      inputs:
        command: 'build'
        # Change directory to the app folder first
        workingDirectory: '$(APP_FOLDER)'
        # Dockerfile path is now local to the working directory
        Dockerfile: 'Dockerfile'
        # Build context is the current folder (the app folder)
        buildContext: '.'
        tags: |
          $(DOCKER_REGISTRY_PATH)/$(IMAGE_NAME):$(IMAGE_TAG)
          $(DOCKER_REGISTRY_PATH)/$(IMAGE_NAME):latest
          
    # 5. Push the Docker Image (FIXED PATHS)
    - task: Docker@2
      displayName: '5. Push Docker Image'
      inputs:
        command: 'push'
        # The working directory setting from build carries over, making this robust
        workingDirectory: '$(APP_FOLDER)'
        tags: |
          $(DOCKER_REGISTRY_PATH)/$(IMAGE_NAME):$(IMAGE_TAG)
          $(DOCKER_REGISTRY_PATH)/$(IMAGE_NAME):latest
          
    # 6. Deploy to Cloud Run (using the native gcloud CLI)
    - script: |
        gcloud run deploy $(GCP_SERVICE_NAME) \
          --image=$(DOCKER_REGISTRY_PATH)/$(IMAGE_NAME):$(IMAGE_TAG) \
          --region=$(GCP_REGION) \
          --project=$(GCP_PROJECT_ID) \
          --platform=managed
      displayName: '6. Deploy to Cloud Run'