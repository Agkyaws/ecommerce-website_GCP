# This pipeline is triggered by pushes to the 'main' branch
trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: gcp-secrets
- name: GCP_PROJECT_ID
  value: 'tranquil-leaf-472813-v8'
- name: GCP_REGION
  value: 'us-central1'
- name: GCP_SERVICE_NAME
  value: 'shop-app'
- name: DOCKER_REGISTRY_PATH
  value: 'us-central1-docker.pkg.dev/tranquil-leaf-472813-v8/shop-app-repo'
- name: IMAGE_NAME
  value: 'shop-app'
- name: IMAGE_TAG
  value: '$(Build.BuildId)'

stages:
- stage: Build_and_Deploy
  displayName: Build and Deploy to Cloud Run
  jobs:
  - job: Deploy
    displayName: Build, Push, and Deploy
    steps:
    
    # 1. Checkout code
    - checkout: self
      displayName: 'Checkout Code'
    
    # 2. Write the raw SA Key to a temporary file
    - script: |
        echo '$(GCP_SA_KEY)' > $(Agent.TempDirectory)/gcp-key.json
      displayName: '1. Write SA Key (Raw JSON)'

    # 3. Activate the Service Account
    - script: |
        gcloud auth activate-service-account --key-file=$(Agent.TempDirectory)/gcp-key.json --project=$(GCP_PROJECT_ID)
      displayName: '2. Activate Service Account'
      
    # 4. Configure Docker for Artifact Registry
    - script: gcloud auth configure-docker $(GCP_REGION)-docker.pkg.dev --quiet
      displayName: '3. Configure Docker for Artifact Registry'
      
    # 5. Build the Docker Image
    - script: |
        docker build -t $(DOCKER_REGISTRY_PATH)/$(IMAGE_NAME):$(IMAGE_TAG) -t $(DOCKER_REGISTRY_PATH)/$(IMAGE_NAME):latest ./app
      displayName: '4. Build Docker Image'
      
    # 6. Push the Docker Image
    - script: |
        docker push $(DOCKER_REGISTRY_PATH)/$(IMAGE_NAME):$(IMAGE_TAG)
        docker push $(DOCKER_REGISTRY_PATH)/$(IMAGE_NAME):latest
      displayName: '5. Push Docker Image'
          
    # 7. Deploy to Cloud Run with ALL environment variables
    - script: |
        gcloud run deploy $(GCP_SERVICE_NAME) \
          --image=$(DOCKER_REGISTRY_PATH)/$(IMAGE_NAME):$(IMAGE_TAG) \
          --region=$(GCP_REGION) \
          --project=$(GCP_PROJECT_ID) \
          --platform=managed \
          --allow-unauthenticated \
          --timeout=600 \
          --cpu=1 \
          --memory=1Gi \
          --set-env-vars="DB_HOST=$(DB_HOST)" \
          --set-env-vars="DB_NAME=$(DB_NAME)" \
          --set-env-vars="DB_USER=$(DB_USER)" \
          --set-secrets="DB_PASS=projects/$(GCP_PROJECT_ID)/secrets/shop-app-db-user-pass:latest" \
          --set-env-vars="SECRET_KEY=$(FLASK_SECRET_KEY)" \
          --set-env-vars="GCP_PROJECT=$(GCP_PROJECT_ID)" \
          --set-env-vars="UPLOAD_BUCKET=$(UPLOAD_BUCKET)" \
          --set-env-vars="ENABLE_SWAGGER=true" \
          --update-secrets=DB_PASS=projects/$(GCP_PROJECT_ID)/secrets/shop-app-db-user-pass:latest
      displayName: '6. Deploy to Cloud Run'
      env:
        DB_HOST: $(DB_HOST)
        DB_NAME: $(DB_NAME)
        DB_USER: $(DB_USER)
        FLASK_SECRET_KEY: $(FLASK_SECRET_KEY)
        UPLOAD_BUCKET: $(UPLOAD_BUCKET)

    # 8. Verify deployment
    - script: |
        echo "Deployment completed successfully!"
        echo "Service URL: $(gcloud run services describe $(GCP_SERVICE_NAME) --region=$(GCP_REGION) --format='value(status.url)')"
      displayName: '7. Verify Deployment'