<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - My E-Commerce Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container max-w-7xl mx-auto p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
            <div class="flex gap-4">
                <button id="back-to-shop" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                    Back to Shop
                </button>
                <button id="add-product-btn" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                    Add New Product
                </button>
                <button id="api-docs-btn" class="bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">
                    API Docs
                </button>
            </div>
        </nav>
    </header>

    <main class="container max-w-7xl mx-auto p-4 sm:p-8">
        <!-- User Management Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">User Management</h2>
            
            <!-- Users Table -->
            <div class="overflow-x-auto">
                <table class="w-full table-auto">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-4 py-2 text-left">Username</th>
                            <th class="px-4 py-2 text-left">Email</th>
                            <th class="px-4 py-2 text-left">Role</th>
                            <th class="px-4 py-2 text-left">Status</th>
                            <th class="px-4 py-2 text-left">Created</th>
                            <th class="px-4 py-2 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-users-table">
                        <!-- Users will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Products Management Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Products Management</h2>
            
            <!-- Search and Filters -->
            <div class="flex gap-4 mb-6">
                <input type="text" id="admin-search" placeholder="Search products..." class="flex-grow px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select id="category-filter" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Categories</option>
                    <option value="Electronics">Electronics</option>
                    <option value="Homeware">Homeware</option>
                    <option value="Apparel">Apparel</option>
                </select>
            </div>

            <!-- Products Table -->
            <div class="overflow-x-auto">
                <table class="w-full table-auto">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-4 py-2 text-left">Image</th>
                            <th class="px-4 py-2 text-left">Name</th>
                            <th class="px-4 py-2 text-left">Category</th>
                            <th class="px-4 py-2 text-left">Price</th>
                            <th class="px-4 py-2 text-left">Stock</th>
                            <th class="px-4 py-2 text-left">Status</th>
                            <th class="px-4 py-2 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-products-table">
                        <!-- Products will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Inventory Overview -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Total Products</h3>
                <p id="total-products" class="text-3xl font-bold text-blue-600">0</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Low Stock Items</h3>
                <p id="low-stock-count" class="text-3xl font-bold text-yellow-600">0</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Out of Stock</h3>
                <p id="out-of-stock-count" class="text-3xl font-bold text-red-600">0</p>
            </div>
        </div>
    </main>

    <!-- Add/Edit Product Modal -->
    <div id="product-form-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-90vh overflow-y-auto">
            <div class="p-6">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-900 mb-6">Add New Product</h2>
                
                <form id="product-form" class="space-y-4">
                    <input type="hidden" id="product-id">
                    
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-gray-700">Product Name *</label>
                        <input type="text" id="product-name" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label for="product-description" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="product-description" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="product-price" class="block text-sm font-medium text-gray-700">Price ($) *</label>
                            <input type="number" id="product-price" step="0.01" min="0" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="product-category" class="block text-sm font-medium text-gray-700">Category *</label>
                            <select id="product-category" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Category</option>
                                <option value="Electronics">Electronics</option>
                                <option value="Homeware">Homeware</option>
                                <option value="Apparel">Apparel</option>
                            </select>
                        </div>
                    </div>

                    <!-- Image Upload Section -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Product Image</label>
                        
                        <!-- Image Preview -->
                        <div id="image-preview" class="mt-2 hidden">
                            <img id="preview-image" src="" alt="Preview" class="w-32 h-32 object-cover rounded-lg border">
                            <p id="image-name" class="text-sm text-gray-500 mt-1"></p>
                        </div>

                        <!-- Upload Controls -->
                        <div class="mt-2 flex items-center gap-4">
                            <label for="image-upload" class="cursor-pointer bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                Choose Image
                            </label>
                            <input type="file" id="image-upload" accept="image/*" class="hidden">
                            <button type="button" id="remove-image" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors hidden">
                                Remove
                            </button>
                        </div>
                        
                        <!-- Upload Progress -->
                        <div id="upload-progress" class="mt-2 hidden">
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <p id="progress-text" class="text-sm text-gray-600 mt-1">Uploading...</p>
                        </div>

                        <p class="text-xs text-gray-500 mt-1">
                            Supported formats: PNG, JPG, JPEG, GIF, WEBP. Max size: 16MB
                        </p>
                    </div>

                    <div>
                        <label for="product-quantity" class="block text-sm font-medium text-gray-700">Initial Stock Quantity *</label>
                        <input type="number" id="product-quantity" min="0" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="flex gap-4 pt-4">
                        <button type="submit" id="save-product-btn" class="flex-grow bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            Save Product
                        </button>
                        <button type="button" id="cancel-product-btn" class="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Admin dashboard loaded.');

            const backToShopBtn = document.getElementById('back-to-shop');
            const addProductBtn = document.getElementById('add-product-btn');
            const apiDocsBtn = document.getElementById('api-docs-btn');
            const adminSearch = document.getElementById('admin-search');
            const categoryFilter = document.getElementById('category-filter');
            const productsTable = document.getElementById('admin-products-table');
            const usersTable = document.getElementById('admin-users-table');
            const productFormModal = document.getElementById('product-form-modal');
            const productForm = document.getElementById('product-form');
            const modalTitle = document.getElementById('modal-title');
            const cancelProductBtn = document.getElementById('cancel-product-btn');
            const totalProductsEl = document.getElementById('total-products');
            const lowStockCountEl = document.getElementById('low-stock-count');
            const outOfStockCountEl = document.getElementById('out-of-stock-count');
            
            // Image upload elements
            const imageUpload = document.getElementById('image-upload');
            const imagePreview = document.getElementById('image-preview');
            const previewImage = document.getElementById('preview-image');
            const imageName = document.getElementById('image-name');
            const removeImageBtn = document.getElementById('remove-image');
            const uploadProgress = document.getElementById('upload-progress');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            let allProducts = [];
            let allUsers = [];
            let editingProductId = null;
            let currentImageUrl = '';

            // Navigation
            backToShopBtn.addEventListener('click', () => {
                window.location.href = '/';
            });

            apiDocsBtn.addEventListener('click', () => {
                window.location.href = '/api-docs';
            });

            addProductBtn.addEventListener('click', () => {
                openProductModal();
            });

            cancelProductBtn.addEventListener('click', () => {
                closeProductModal();
            });

            // Image upload handling
            imageUpload.addEventListener('change', handleImageUpload);
            removeImageBtn.addEventListener('click', removeImage);

            // Search and filter
            adminSearch.addEventListener('input', filterProducts);
            categoryFilter.addEventListener('change', filterProducts);

            // Load products and users
            loadAdminProducts();
            loadUsers();

            async function loadAdminProducts() {
                try {
                    const response = await fetch('/api/products?admin=true');
                    if (!response.ok) throw new Error('Failed to fetch products');
                    
                    allProducts = await response.json();
                    renderProductsTable(allProducts);
                    updateDashboardStats(allProducts);
                } catch (error) {
                    console.error('Error loading products:', error);
                    productsTable.innerHTML = '<tr><td colspan="7" class="px-4 py-2 text-center text-red-500">Error loading products</td></tr>';
                }
            }

            async function loadUsers() {
                try {
                    const response = await fetch('/api/admin/users');
                    if (!response.ok) throw new Error('Failed to fetch users');
                    
                    allUsers = await response.json();
                    renderUsersTable(allUsers);
                } catch (error) {
                    console.error('Error loading users:', error);
                    usersTable.innerHTML = '<tr><td colspan="6" class="px-4 py-2 text-center text-red-500">Error loading users</td></tr>';
                }
            }

            function renderUsersTable(users) {
                usersTable.innerHTML = '';
                
                if (users.length === 0) {
                    usersTable.innerHTML = '<tr><td colspan="6" class="px-4 py-2 text-center text-gray-500">No users found</td></tr>';
                    return;
                }

                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-4 py-2 font-semibold">${user.username}</td>
                        <td class="px-4 py-2">${user.email}</td>
                        <td class="px-4 py-2">
                            <select class="user-role-select border rounded px-2 py-1" data-user-id="${user.user_id}">
                                <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                                <option value="seller" ${user.role === 'seller' ? 'selected' : ''}>Seller</option>
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                            </select>
                        </td>
                        <td class="px-4 py-2">
                            ${user.approved ? 
                                '<span class="inline-block bg-green-100 text-green-800 text-xs font-semibold px-2 py-1 rounded-full">Approved</span>' : 
                                '<span class="inline-block bg-yellow-100 text-yellow-800 text-xs font-semibold px-2 py-1 rounded-full">Pending</span>'
                            }
                        </td>
                        <td class="px-4 py-2">${new Date(user.created_at).toLocaleDateString()}</td>
                        <td class="px-4 py-2">
                            ${!user.approved ? `
                                <button class="approve-user-btn bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 mr-2" data-user-id="${user.user_id}">
                                    Approve
                                </button>
                            ` : ''}
                        </td>
                    `;
                    usersTable.appendChild(row);
                });

                // Add event listeners to user management buttons
                document.querySelectorAll('.approve-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.dataset.userId;
                        approveUser(userId);
                    });
                });

                document.querySelectorAll('.user-role-select').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const userId = e.target.dataset.userId;
                        const newRole = e.target.value;
                        updateUserRole(userId, newRole);
                    });
                });
            }

            function renderProductsTable(products) {
                productsTable.innerHTML = '';
                
                if (products.length === 0) {
                    productsTable.innerHTML = '<tr><td colspan="7" class="px-4 py-2 text-center text-gray-500">No products found</td></tr>';
                    return;
                }

                products.forEach(product => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-4 py-2">
                            <img src="${product.image_url}" alt="${product.name}" class="w-12 h-12 object-cover rounded">
                        </td>
                        <td class="px-4 py-2 font-semibold">${product.name}</td>
                        <td class="px-4 py-2">${product.category}</td>
                        <td class="px-4 py-2">$${product.price.toFixed(2)}</td>
                        <td class="px-4 py-2">${product.quantity}</td>
                        <td class="px-4 py-2">
                            ${getStatusBadge(product.stock_status)}
                        </td>
                        <td class="px-4 py-2">
                            <button class="edit-product-btn bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600 mr-2" data-id="${product.product_id}">
                                Edit
                            </button>
                            <button class="delete-product-btn bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600" data-id="${product.product_id}">
                                Delete
                            </button>
                        </td>
                    `;
                    productsTable.appendChild(row);
                });

                // Add event listeners to buttons
                document.querySelectorAll('.edit-product-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productId = e.target.dataset.id;
                        editProduct(productId);
                    });
                });

                document.querySelectorAll('.delete-product-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productId = e.target.dataset.id;
                        deleteProduct(productId);
                    });
                });
            }

            function getStatusBadge(status) {
                if (status === 'In Stock') return '<span class="inline-block bg-green-100 text-green-800 text-xs font-semibold px-2 py-1 rounded-full">In Stock</span>';
                if (status === 'Low Stock') return '<span class="inline-block bg-yellow-100 text-yellow-800 text-xs font-semibold px-2 py-1 rounded-full">Low Stock</span>';
                if (status === 'Out of Stock') return '<span class="inline-block bg-red-100 text-red-800 text-xs font-semibold px-2 py-1 rounded-full">Out of Stock</span>';
                return '';
            }

            function filterProducts() {
                const searchTerm = adminSearch.value.toLowerCase();
                const category = categoryFilter.value;
                
                let filtered = allProducts.filter(product => {
                    const matchesSearch = product.name.toLowerCase().includes(searchTerm) || 
                                        product.description.toLowerCase().includes(searchTerm);
                    const matchesCategory = !category || product.category === category;
                    return matchesSearch && matchesCategory;
                });

                renderProductsTable(filtered);
            }

            function updateDashboardStats(products) {
                totalProductsEl.textContent = products.length;
                
                const lowStock = products.filter(p => p.stock_status === 'Low Stock').length;
                const outOfStock = products.filter(p => p.stock_status === 'Out of Stock').length;
                
                lowStockCountEl.textContent = lowStock;
                outOfStockCountEl.textContent = outOfStock;
            }

            async function approveUser(userId) {
                try {
                    const response = await fetch(`/api/admin/users/${userId}/approve`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        await loadUsers();
                    } else {
                        alert('Failed to approve user');
                    }
                } catch (error) {
                    console.error('Error approving user:', error);
                    alert('Error approving user');
                }
            }

            async function updateUserRole(userId, newRole) {
                try {
                    const response = await fetch(`/api/admin/users/${userId}/role`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ role: newRole })
                    });

                    if (!response.ok) {
                        alert('Failed to update user role');
                        // Reload to reset the select
                        await loadUsers();
                    }
                } catch (error) {
                    console.error('Error updating user role:', error);
                    alert('Error updating user role');
                    await loadUsers();
                }
            }

            function openProductModal(product = null) {
                editingProductId = product ? product.product_id : null;
                currentImageUrl = product ? product.image_url : '';
                
                if (product) {
                    modalTitle.textContent = 'Edit Product';
                    document.getElementById('product-id').value = product.product_id;
                    document.getElementById('product-name').value = product.name;
                    document.getElementById('product-description').value = product.description;
                    document.getElementById('product-price').value = product.price;
                    document.getElementById('product-category').value = product.category;
                    document.getElementById('product-quantity').value = product.quantity;
                    
                    // Show existing image
                    if (product.image_url) {
                        previewImage.src = product.image_url;
                        imageName.textContent = 'Current image';
                        imagePreview.classList.remove('hidden');
                        removeImageBtn.classList.remove('hidden');
                    }
                } else {
                    modalTitle.textContent = 'Add New Product';
                    productForm.reset();
                    resetImageUpload();
                }
                
                productFormModal.classList.remove('hidden');
            }

            function closeProductModal() {
                productFormModal.classList.add('hidden');
                editingProductId = null;
                currentImageUrl = '';
                productForm.reset();
                resetImageUpload();
            }

            function resetImageUpload() {
                imagePreview.classList.add('hidden');
                removeImageBtn.classList.add('hidden');
                uploadProgress.classList.add('hidden');
                progressBar.style.width = '0%';
                imageUpload.value = '';
                currentImageUrl = '';
            }

            function removeImage() {
                resetImageUpload();
            }

            async function handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Validate file type and size
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    alert('Please select a valid image file (JPEG, PNG, GIF, or WEBP)');
                    resetImageUpload();
                    return;
                }

                if (file.size > 16 * 1024 * 1024) {
                    alert('File size must be less than 16MB');
                    resetImageUpload();
                    return;
                }

                // Show preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    imageName.textContent = file.name;
                    imagePreview.classList.remove('hidden');
                    removeImageBtn.classList.remove('hidden');
                };
                reader.readAsDataURL(file);

                // Upload to server
                await uploadImage(file);
            }

            async function uploadImage(file) {
                const formData = new FormData();
                formData.append('image', file);

                try {
                    uploadProgress.classList.remove('hidden');
                    progressBar.style.width = '30%';
                    progressText.textContent = 'Uploading...';

                    const response = await fetch('/api/admin/upload', {
                        method: 'POST',
                        body: formData
                    });

                    progressBar.style.width = '100%';

                    if (response.ok) {
                        const result = await response.json();
                        currentImageUrl = result.image_url;
                        progressText.textContent = 'Upload complete!';
                        
                        // Hide progress after a delay
                        setTimeout(() => {
                            uploadProgress.classList.add('hidden');
                        }, 1000);
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || 'Upload failed');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    progressText.textContent = 'Upload failed';
                    progressBar.style.backgroundColor = '#dc2626';
                    alert('Image upload failed: ' + error.message);
                    
                    resetImageUpload();
                }
            }

            async function editProduct(productId) {
                const product = allProducts.find(p => p.product_id === parseInt(productId));
                if (product) {
                    openProductModal(product);
                }
            }

            async function deleteProduct(productId) {
                if (!confirm('Are you sure you want to delete this product?')) {
                    return;
                }

                try {
                    const response = await fetch(`/api/admin/products/${productId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        await loadAdminProducts();
                    } else {
                        alert('Failed to delete product');
                    }
                } catch (error) {
                    console.error('Error deleting product:', error);
                    alert('Error deleting product');
                }
            }

            // Handle form submission
            productForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = {
                    name: document.getElementById('product-name').value,
                    description: document.getElementById('product-description').value,
                    price: parseFloat(document.getElementById('product-price').value),
                    category: document.getElementById('product-category').value,
                    quantity: parseInt(document.getElementById('product-quantity').value)
                };

                // Use uploaded image URL if available, otherwise keep existing one for edits
                if (currentImageUrl) {
                    formData.image_url = currentImageUrl;
                } else if (editingProductId) {
                    // For edits, if no new image uploaded, keep the existing one
                    const existingProduct = allProducts.find(p => p.product_id === editingProductId);
                    formData.image_url = existingProduct ? existingProduct.image_url : '/static/default.png';
                } else {
                    formData.image_url = '/static/default.png';
                }

                try {
                    const url = editingProductId ? 
                        `/api/admin/products/${editingProductId}` : 
                        '/api/admin/products';
                    
                    const method = editingProductId ? 'PUT' : 'POST';

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        closeProductModal();
                        await loadAdminProducts();
                    } else {
                        const error = await response.json();
                        alert('Failed to save product: ' + (error.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error saving product:', error);
                    alert('Error saving product: ' + error.message);
                }
            });
        });
    </script>
</body>
</html>