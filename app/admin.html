<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - CircuitCart</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container max-w-7xl mx-auto p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
            <div class="flex gap-4">
                <button id="back-to-shop" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                    Back to Shop
                </button>
                <button id="swagger-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                    API Docs
                </button>
                <button id="logout-btn" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                    Logout
                </button>
            </div>
        </nav>
    </header>

    <main class="container max-w-7xl mx-auto p-4 sm:p-8">
        <!-- User Management Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">User Management</h2>
            
            <!-- Users Table -->
            <div class="overflow-x-auto">
                <table class="w-full table-auto">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-4 py-2 text-left">Username</th>
                            <th class="px-4 py-2 text-left">Email</th>
                            <th class="px-4 py-2 text-left">Role</th>
                            <th class="px-4 py-2 text-left">Status</th>
                            <th class="px-4 py-2 text-left">Created</th>
                            <th class="px-4 py-2 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table">
                        <!-- Users will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Products Management Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Products Management</h2>
            
            <!-- Search and Filters -->
            <div class="flex gap-4 mb-6">
                <input type="text" id="admin-search" placeholder="Search products..." class="flex-grow px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select id="category-filter" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Categories</option>
                    <option value="Electronics">Electronics</option>
                    <option value="Homeware">Homeware</option>
                    <option value="Apparel">Apparel</option>
                </select>
            </div>

            <!-- Products Table -->
            <div class="overflow-x-auto">
                <table class="w-full table-auto">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-4 py-2 text-left">Image</th>
                            <th class="px-4 py-2 text-left">Name</th>
                            <th class="px-4 py-2 text-left">Category</th>
                            <th class="px-4 py-2 text-left">Price</th>
                            <th class="px-4 py-2 text-left">Stock</th>
                            <th class="px-4 py-2 text-left">Status</th>
                            <th class="px-4 py-2 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-products-table">
                        <!-- Products will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Inventory Overview -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Total Products</h3>
                <p id="total-products" class="text-3xl font-bold text-blue-600">0</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Low Stock Items</h3>
                <p id="low-stock-count" class="text-3xl font-bold text-yellow-600">0</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Out of Stock</h3>
                <p id="out-of-stock-count" class="text-3xl font-bold text-red-600">0</p>
            </div>
        </div>
    </main>

    <!-- Role Update Modal -->
    <div id="role-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full">
            <div class="p-6">
                <h2 id="role-modal-title" class="text-2xl font-bold text-gray-900 mb-6">Update User Role</h2>
                
                <form id="role-form" class="space-y-4">
                    <input type="hidden" id="role-user-id">
                    
                    <div>
                        <label for="user-role-select" class="block text-sm font-medium text-gray-700">Role</label>
                        <select id="user-role-select" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="user">User</option>
                            <option value="seller">Seller</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>

                    <div class="flex gap-4 pt-4">
                        <button type="submit" class="flex-grow bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            Update Role
                        </button>
                        <button type="button" id="cancel-role-btn" class="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Admin dashboard loaded.');

            const backToShopBtn = document.getElementById('back-to-shop');
            const swaggerBtn = document.getElementById('swagger-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const adminSearch = document.getElementById('admin-search');
            const categoryFilter = document.getElementById('category-filter');
            const productsTable = document.getElementById('admin-products-table');
            const usersTable = document.getElementById('users-table');
            const totalProductsEl = document.getElementById('total-products');
            const lowStockCountEl = document.getElementById('low-stock-count');
            const outOfStockCountEl = document.getElementById('out-of-stock-count');
            
            // Role modal elements
            const roleModal = document.getElementById('role-modal');
            const roleForm = document.getElementById('role-form');
            const roleUserId = document.getElementById('role-user-id');
            const userRoleSelect = document.getElementById('user-role-select');
            const cancelRoleBtn = document.getElementById('cancel-role-btn');

            let allProducts = [];
            let allUsers = [];

            // Navigation
            backToShopBtn.addEventListener('click', () => {
                window.location.href = '/';
            });

            swaggerBtn.addEventListener('click', () => {
                window.location.href = '/swagger-ui';
            });

            logoutBtn.addEventListener('click', async () => {
                try {
                    await fetch('/api/auth/logout', { method: 'POST' });
                    window.location.href = '/';
                } catch (error) {
                    console.error('Logout failed:', error);
                }
            });

            // Search and filter
            adminSearch.addEventListener('input', filterProducts);
            categoryFilter.addEventListener('change', filterProducts);

            // Role modal
            cancelRoleBtn.addEventListener('click', () => {
                roleModal.classList.add('hidden');
            });

            roleForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userId = parseInt(roleUserId.value);
                const role = userRoleSelect.value;

                try {
                    const response = await fetch(`/api/admin/users/${userId}/role`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ role })
                    });

                    if (response.ok) {
                        roleModal.classList.add('hidden');
                        await loadUsers();
                    } else {
                        const error = await response.json();
                        alert('Failed to update role: ' + error.error);
                    }
                } catch (error) {
                    console.error('Error updating role:', error);
                    alert('Error updating role');
                }
            });

            // Load data
            loadAdminProducts();
            loadUsers();

            async function loadAdminProducts() {
                try {
                    const response = await fetch('/api/products?admin=true');
                    if (!response.ok) throw new Error('Failed to fetch products');
                    
                    allProducts = await response.json();
                    renderProductsTable(allProducts);
                    updateDashboardStats(allProducts);
                } catch (error) {
                    console.error('Error loading products:', error);
                    productsTable.innerHTML = '<tr><td colspan="7" class="px-4 py-2 text-center text-red-500">Error loading products</td></tr>';
                }
            }

            async function loadUsers() {
                try {
                    const response = await fetch('/api/admin/users');
                    if (!response.ok) throw new Error('Failed to fetch users');
                    
                    allUsers = await response.json();
                    renderUsersTable(allUsers);
                } catch (error) {
                    console.error('Error loading users:', error);
                    usersTable.innerHTML = '<tr><td colspan="6" class="px-4 py-2 text-center text-red-500">Error loading users</td></tr>';
                }
            }

            function renderProductsTable(products) {
                productsTable.innerHTML = '';
                
                if (products.length === 0) {
                    productsTable.innerHTML = '<tr><td colspan="7" class="px-4 py-2 text-center text-gray-500">No products found</td></tr>';
                    return;
                }

                products.forEach(product => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-4 py-2">
                            <img src="${product.image_url}" alt="${product.name}" class="w-12 h-12 object-cover rounded">
                        </td>
                        <td class="px-4 py-2 font-semibold">${product.name}</td>
                        <td class="px-4 py-2">${product.category}</td>
                        <td class="px-4 py-2">$${product.price.toFixed(2)}</td>
                        <td class="px-4 py-2">${product.quantity}</td>
                        <td class="px-4 py-2">
                            ${getStatusBadge(product.stock_status)}
                        </td>
                        <td class="px-4 py-2">
                            <button class="edit-product-btn bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600 mr-2" data-id="${product.product_id}">
                                Edit
                            </button>
                            <button class="delete-product-btn bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600" data-id="${product.product_id}">
                                Delete
                            </button>
                        </td>
                    `;
                    productsTable.appendChild(row);
                });

                // Add event listeners to buttons
                document.querySelectorAll('.edit-product-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productId = e.target.dataset.id;
                        editProduct(productId);
                    });
                });

                document.querySelectorAll('.delete-product-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productId = e.target.dataset.id;
                        deleteProduct(productId);
                    });
                });
            }

            function renderUsersTable(users) {
                usersTable.innerHTML = '';
                
                if (users.length === 0) {
                    usersTable.innerHTML = '<tr><td colspan="6" class="px-4 py-2 text-center text-gray-500">No users found</td></tr>';
                    return;
                }

                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-4 py-2 font-semibold">${user.username}</td>
                        <td class="px-4 py-2">${user.email}</td>
                        <td class="px-4 py-2">
                            <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full">${user.role}</span>
                        </td>
                        <td class="px-4 py-2">
                            ${user.approved ? 
                                '<span class="inline-block bg-green-100 text-green-800 text-xs font-semibold px-2 py-1 rounded-full">Approved</span>' :
                                '<span class="inline-block bg-yellow-100 text-yellow-800 text-xs font-semibold px-2 py-1 rounded-full">Pending</span>'
                            }
                        </td>
                        <td class="px-4 py-2 text-sm text-gray-500">${new Date(user.created_at).toLocaleDateString()}</td>
                        <td class="px-4 py-2">
                            ${!user.approved ? `
                                <button class="approve-user-btn bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 mr-2" data-id="${user.user_id}">
                                    Approve
                                </button>
                            ` : ''}
                            <button class="update-role-btn bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 mr-2" data-id="${user.user_id}" data-role="${user.role}">
                                Role
                            </button>
                            <button class="delete-user-btn bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600" data-id="${user.user_id}">
                                Delete
                            </button>
                        </td>
                    `;
                    usersTable.appendChild(row);
                });

                // Add event listeners to user buttons
                document.querySelectorAll('.approve-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.dataset.id;
                        approveUser(userId);
                    });
                });

                document.querySelectorAll('.update-role-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.dataset.id;
                        const currentRole = e.target.dataset.role;
                        openRoleModal(userId, currentRole);
                    });
                });

                document.querySelectorAll('.delete-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.dataset.id;
                        deleteUser(userId);
                    });
                });
            }

            function getStatusBadge(status) {
                if (status === 'In Stock') return '<span class="inline-block bg-green-100 text-green-800 text-xs font-semibold px-2 py-1 rounded-full">In Stock</span>';
                if (status === 'Low Stock') return '<span class="inline-block bg-yellow-100 text-yellow-800 text-xs font-semibold px-2 py-1 rounded-full">Low Stock</span>';
                if (status === 'Out of Stock') return '<span class="inline-block bg-red-100 text-red-800 text-xs font-semibold px-2 py-1 rounded-full">Out of Stock</span>';
                return '';
            }

            function filterProducts() {
                const searchTerm = adminSearch.value.toLowerCase();
                const category = categoryFilter.value;
                
                let filtered = allProducts.filter(product => {
                    const matchesSearch = product.name.toLowerCase().includes(searchTerm) || 
                                        product.description.toLowerCase().includes(searchTerm);
                    const matchesCategory = !category || product.category === category;
                    return matchesSearch && matchesCategory;
                });

                renderProductsTable(filtered);
            }

            function updateDashboardStats(products) {
                totalProductsEl.textContent = products.length;
                
                const lowStock = products.filter(p => p.stock_status === 'Low Stock').length;
                const outOfStock = products.filter(p => p.stock_status === 'Out of Stock').length;
                
                lowStockCountEl.textContent = lowStock;
                outOfStockCountEl.textContent = outOfStock;
            }

            function openRoleModal(userId, currentRole) {
                roleUserId.value = userId;
                userRoleSelect.value = currentRole;
                roleModal.classList.remove('hidden');
            }

            async function approveUser(userId) {
                try {
                    const response = await fetch(`/api/admin/users/${userId}/approve`, {
                        method: 'PUT'
                    });

                    if (response.ok) {
                        await loadUsers();
                    } else {
                        alert('Failed to approve user');
                    }
                } catch (error) {
                    console.error('Error approving user:', error);
                    alert('Error approving user');
                }
            }

            async function deleteUser(userId) {
                if (!confirm('Are you sure you want to delete this user?')) {
                    return;
                }

                try {
                    const response = await fetch(`/api/admin/users/${userId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        await loadUsers();
                    } else {
                        const error = await response.json();
                        alert('Failed to delete user: ' + error.error);
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Error deleting user');
                }
            }

            async function editProduct(productId) {
                const product = allProducts.find(p => p.product_id === parseInt(productId));
                if (product) {
                    // Redirect to main page for editing (since modal is there now)
                    window.location.href = '/';
                    // Note: In a real implementation, you might want to pass the product ID
                    // and automatically open the modal on the main page
                }
            }

            async function deleteProduct(productId) {
                if (!confirm('Are you sure you want to delete this product?')) {
                    return;
                }

                try {
                    const response = await fetch(`/api/admin/products/${productId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        await loadAdminProducts();
                    } else {
                        alert('Failed to delete product');
                    }
                } catch (error) {
                    console.error('Error deleting product:', error);
                    alert('Error deleting product');
                }
            }
        });
    </script>
</body>
</html>